/**
 * This ruleset enforces a strict patient-ownership security model for a health dashboard application.
 *
 * Core Philosophy:
 * The fundamental principle is that users (patients) have exclusive control over their own data.
 * All sensitive health information, such as prescriptions, appointments, and uploads, is
 * accessible only by the authenticated patient to whom it belongs.
 *
 * Data Structure:
 * All patient-specific data is hierarchically organized under the `/patients/{patientId}` path, where
 * `patientId` corresponds to the user's Firebase Authentication UID. This structure inherently
 * isolates each patient's data, simplifying security logic. The `/doctors` collection is a top-level,
 * read-only collection containing public information.
 *
 * Key Security Decisions:
 * - User Enumeration Disabled: Listing the top-level `/patients` collection is explicitly forbidden to
 *   protect patient privacy and prevent discovery of the user base.
 * - Patient Data Isolation: All rules for subcollections under `/patients/{patientId}` verify that the
 *   requester's UID matches the `patientId` in the path.
 * - Read-Only Public Data: The `/doctors` collection is publicly readable by anyone but cannot be
 *   modified through client applications, ensuring data integrity. A more complex role-based system
 *   would be required to allow administrative writes.
 * - Relational Integrity: On creation, documents within a patient's data tree (e.g., a prescription)
 *   must contain a `patientId` field that matches the `patientId` from the path, ensuring data consistency.
 *   This link is immutable and cannot be changed on update.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the core of the ownership-based security model.
     * @param userId The user ID to check against the authenticated user.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing document.
     * CRITICAL: Used for all update and delete operations to prevent modifying
     * or deleting documents that do not exist.
     * @param userId The user ID to verify ownership.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * VALIDATION: On create, ensures the new patient document's `id` field
     * matches the UID in the path.
     */
    function hasValidPatientId(patientId) {
      return request.resource.data.id == patientId;
    }

    /**
     * VALIDATION: On update, ensures the patient document's `id` field is immutable.
     */
    function isPatientIdImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * VALIDATION: On create, ensures a subcollection document contains a `patientId`
     * field that correctly links it back to its parent patient document.
     */
    function hasValidPatientLink(patientId) {
      return request.resource.data.patientId == patientId;
    }

    /**
     * VALIDATION: On update, ensures the `patientId` field within a subcollection
     * document is immutable, preventing it from being reassigned to another patient.
     */
    function isPatientLinkImmutable() {
      return request.resource.data.patientId == resource.data.patientId;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages patient profile documents. Each patient can create their own profile and
     *              subsequently manage it. Listing all patients is denied.
     * @path /patients/{patientId}
     * @allow (create) An authenticated user creating their own patient document with a matching ID.
     * @deny (list) Any user attempting to list all patients in the system.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    /**
     * Checks if the authenticated user is a hospital.
     */
    function isHospital() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'hospital';
    }

    /**
     * Checks if the authenticated user is a patient.
     */
    function isPatient() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'patient';
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Public user profiles created during signup.
     */
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
    }

    /**
     * @description patient documents (legacy path or internal).
     */
    match /patients/{patientId} {
      allow get: if isOwner(patientId) || isHospital();
      allow list: if isHospital();
      allow create: if isOwner(patientId);
      allow update: if isOwner(patientId);
      allow delete: if isOwner(patientId);
    }

    /**
     * @description Secures prescriptions. Only hospitals can create/update. Patients can only read.
     */
    match /patients/{patientId}/prescriptions/{prescriptionId} {
      allow read: if isOwner(patientId) || isHospital();
      allow create, update: if isHospital();
      allow delete: if isHospital();
    }

    /**
     * @description Secures appointments. Both can read, patients create, hospitals update.
     */
    match /patients/{patientId}/appointments/{appointmentId} {
      allow read: if isOwner(patientId) || isHospital();
      allow create: if isOwner(patientId);
      allow update: if isOwner(patientId) || isHospital();
      allow delete: if isOwner(patientId) || isHospital();
    }

    /**
     * @description Secure top-level doctor directory. Hospitals can manage their doctors.
     */
    match /doctors/{doctorId} {
      allow read: if true;
      allow create, update, delete: if isHospital();
    }

    /**
     * @description Secures hospital-specific settings and data.
     */
    match /hospitals/{hospitalId} {
      allow read: if true;
      allow write: if isHospital();
    }

    /**
     * @description legacy appointments path.
     */
    match /appointments/{appointmentId} {
      allow read: if isSignedIn();
      allow create: if isPatient();
      allow update: if isOwner(resource.data.patientId) || isHospital();
    }
  }
}
  }
}
